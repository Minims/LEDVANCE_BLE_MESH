name: Build ESP-IDF Project

on:
  push:
    branches:
      - dev
    paths:
      - 'main/**'
      - 'web/**'
      - 'CMakeLists.txt'
      - 'sdkconfig.defaults'
      - 'partitions.csv'
      - '.github/workflows/build.yml'
  pull_request:
    paths:
      - 'main/**'
      - 'web/**'
      - 'CMakeLists.txt'
      - 'sdkconfig.defaults'
      - 'partitions.csv'
      - '.github/workflows/build.yml'
  
# Grant permissions for GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  
jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # List the targets you want to build for here
        target: [esp32, esp32c3, esp32c6, esp32s3]
    
    # Use the official Espressif IDF Docker image
    # 'latest' usually points to the latest stable release (currently v5.x)
    container: espressif/idf:release-v5.4

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Build Firmware
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          idf.py set-target ${{ matrix.target }}
          idf.py build
          idf.py merge-bin # Creates build/merged-binary.bin

      - name: Upload Single Binary
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.target }}
          path: build/merged-binary.bin
  deploy-web:
    needs: build
    runs-on: ubuntu-latest
    name: Deploy to GitHub Pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup Web Directory
        run: |
          mkdir -p public/firmware
          cp web/index.html public/index.html

      - name: Process Firmware & Generate Manifests
        run: |
          for chip in esp32 esp32c3 esp32c6 esp32s3; do
            echo "Processing $chip..."
            mkdir -p public/firmware/$chip
            
            # Map build target to correct ESP Web Tools chipFamily name
            case $chip in
              esp32)   FAMILY="ESP32" ;;
              esp32c3) FAMILY="ESP32-C3" ;;
              esp32c6) FAMILY="ESP32-C6" ;;
              esp32s3) FAMILY="ESP32-S3" ;;
              *)       FAMILY="ESP32" ;; # Default fallback
            esac

            # Move and rename the single binary
            cp artifacts/firmware-$chip/merged-binary.bin public/firmware/$chip/firmware.bin
            
            # Generate manifest with correct chipFamily
            cat <<EOF > public/firmware/$chip/manifest.json
          {
            "name": "LEDVANCE BLE Mesh ($FAMILY)",
            "version": "latest",
            "builds": [
              {
                "chipFamily": "$FAMILY",
                "parts": [
                  { "path": "firmware.bin", "offset": 0 }
                ]
              }
            ]
          }
          EOF
          done

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'public'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
